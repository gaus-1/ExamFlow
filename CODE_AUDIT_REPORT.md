# üîç –û–¢–ß–ï–¢ –ü–û –ê–£–î–ò–¢–£ –ö–û–î–ê EXAMFLOW 2.0

## üìä –û–ë–©–ê–Ø –û–¶–ï–ù–ö–ê

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –¢–†–ï–ë–£–ï–¢–°–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø  
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –°–†–ï–î–ù–Ø–Ø  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í–´–°–û–ö–ò–ô  

---

## üéØ 1. –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï PEP 8

### ‚úÖ –•–û–†–û–®–û:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ type hints –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Ñ–∞–π–ª–æ–≤
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ docstrings –≤ –∫–ª–∞—Å—Å–∞—Ö –∏ –º–µ—Ç–æ–¥–∞—Ö
- –õ–æ–≥–∏—á–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–º–ø–æ—Ä—Ç–æ–≤
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

### ‚ùå –ü–†–û–ë–õ–ï–ú–´:
1. **–î–ª–∏–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏** (–ø—Ä–µ–≤—ã—à–∞—é—Ç 88 —Å–∏–º–≤–æ–ª–æ–≤):
   ```python
   # ai/api.py:29
   GEMINI_API_KEY = os.getenv('GEMINI_API_KEY', 'AIzaSyCvi8Mm5paqqV-bakd2N897MgUEvJyWw44')
   ```

2. **–ò–∑–±—ã—Ç–æ—á–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏**:
   ```python
   # core/models.py:30
   return f"{self.name} ({self.get_exam_type_display()})"  # type: ignore
   ```

3. **–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã**:
   ```python
   # ai/api.py:16-17
   from django.contrib.auth.decorators import login_required
   from django.utils.decorators import method_decorator
   ```

---

## üèóÔ∏è 2. –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –ü–†–ò–ù–¶–ò–ü–ê–ú –û–û–ü

### ‚úÖ –•–û–†–û–®–û:
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –∫–ª–∞—Å—Å–∞–º–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è (Enum, dataclass)
- –ò–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –º–æ–¥–µ–ª—è—Ö Django
- –ü–æ–ª–∏–º–æ—Ä—Ñ–∏–∑–º –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö

### ‚ùå –ü–†–û–ë–õ–ï–ú–´:

#### 2.1 –ù–∞—Ä—É—à–µ–Ω–∏–µ Single Responsibility Principle
```python
# ai/api.py - –∫–ª–∞—Å—Å AIAssistantAPI –¥–µ–ª–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ:
class AIAssistantAPI(View):
    def post(self, request):           # HTTP –æ–±—Ä–∞–±–æ—Ç–∫–∞
    def generate_ai_response(self):    # AI –ª–æ–≥–∏–∫–∞
    def detect_subject(self):          # –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞
    def get_sources_for_subject(self): # –ü–æ–∏—Å–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
```

#### 2.2 –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π
```python
# core/data_ingestion/pdf_processor.py
# –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –∫–ª–∞—Å—Å–æ–≤ –±–µ–∑ –æ–±—â–µ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
class OCRProcessor: ...
class PDFTextExtractor: ...
class PDFStructuringEngine: ...
class PDFVectorizer: ...
```

#### 2.3 –ù–∞—Ä—É—à–µ–Ω–∏–µ Dependency Inversion
```python
# core/rag_system/orchestrator.py:26
genai.configure(api_key=settings.GEMINI_API_KEY)  # –ü—Ä—è–º–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
```

---

## ‚ö° 3. –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨

### ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´:

#### 3.1 N+1 Query Problem
```python
# core/models.py:85
'preferred_subjects': [s.name for s in user_profile.preferred_subjects.all()]
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: select_related() –∏–ª–∏ prefetch_related()
```

#### 3.2 –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
```python
# core/rag_system/orchestrator.py:71-73
user_profile = UnifiedProfile.objects.filter(
    models.Q(user_id=user_id) | models.Q(telegram_id=user_id)
).first()
# –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø–æ telegram_id
```

#### 3.3 –ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
```python
# ai/api.py:144
response = model.generate_content(context)  # –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ API
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: async/await –∏–ª–∏ Celery task
```

#### 3.4 –ò–∑–±—ã—Ç–æ—á–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
```python
# ai/api.py:112-113
prompt_hash = hashlib.md5(prompt.lower().strip().encode()).hexdigest()
cache_key = f"ai_response_{prompt_hash}"
# MD5 –Ω–µ–±–µ–∑–æ–ø–∞—Å–µ–Ω, –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SHA-256
```

---

## üîí 4. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –£–Ø–ó–í–ò–ú–û–°–¢–ò:

#### 4.1 –•–∞—Ä–¥–∫–æ–¥ API –∫–ª—é—á–µ–π
```python
# ai/api.py:29
GEMINI_API_KEY = os.getenv('GEMINI_API_KEY', 'AIzaSyCvi8Mm5paqqV-bakd2N897MgUEvJyWw44')
# –ö–ª—é—á –≤ –∫–æ–¥–µ! –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –≤ .env
```

#### 4.2 –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ö–µ—à–∏
```python
# ai/api.py:112
prompt_hash = hashlib.md5(prompt.lower().strip().encode()).hexdigest()
# MD5 —É—è–∑–≤–∏–º –¥–ª—è –∫–æ–ª–ª–∏–∑–∏–π
```

#### 4.3 –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```python
# ai/api.py:76
data = json.loads(request.body)  # –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞
prompt = data.get('prompt', '').strip()  # –ù–µ—Ç —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏
```

#### 4.4 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```python
# ai/api.py:78
logger.info(f"AI API: –ü—Ä–æ–º–ø—Ç: {prompt[:100]}...")
# –ú–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
```

---

## üõ†Ô∏è 5. –£–ü–†–û–©–ï–ù–ò–ï –ö–û–î–ê

### üìã –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:

#### 5.1 –†–∞–∑–¥–µ–ª–∏—Ç—å –±–æ–ª—å—à–∏–µ –∫–ª–∞—Å—Å—ã
```python
# –í–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ AIAssistantAPI —Å–æ–∑–¥–∞—Ç—å:
class AIRequestHandler:      # HTTP –æ–±—Ä–∞–±–æ—Ç–∫–∞
class AIResponseGenerator:   # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤
class SubjectDetector:       # –ê–Ω–∞–ª–∏–∑ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
class SourceProvider:        # –ü–æ–∏—Å–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
```

#### 5.2 –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∞–±—Ä–∏–∫–∏
```python
class AIProviderFactory:
    @staticmethod
    def create_provider(provider_type: str) -> AIProvider:
        if provider_type == 'gemini':
            return GeminiProvider()
        elif provider_type == 'rag':
            return RAGProvider()
```

#### 5.3 –í—ã–Ω–µ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
```python
# settings.py
AI_CONFIG = {
    'max_tokens': 1000,
    'temperature': 0.7,
    'cache_ttl': 3600,
    'max_prompt_length': 500
}
```

---

## üöÄ 6. –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢:

1. **–£–±—Ä–∞—Ç—å API –∫–ª—é—á–∏ –∏–∑ –∫–æ–¥–∞**
2. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å N+1 –∑–∞–ø—Ä–æ—Å—ã**
3. **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
4. **–ó–∞–º–µ–Ω–∏—Ç—å MD5 –Ω–∞ SHA-256**

### ‚ö° –í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢:

1. **–†–∞–∑–¥–µ–ª–∏—Ç—å –±–æ–ª—å—à–∏–µ –∫–ª–∞—Å—Å—ã**
2. **–î–æ–±–∞–≤–∏—Ç—å async/await –¥–ª—è API –≤—ã–∑–æ–≤–æ–≤**
3. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î**
4. **–î–æ–±–∞–≤–∏—Ç—å rate limiting**

### üìà –°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢:

1. **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã**
2. **–î–æ–±–∞–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã**
3. **–£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
4. **–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**

---

## üìà 7. –ú–ï–¢–†–ò–ö–ò –ö–ê–ß–ï–°–¢–í–ê

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –¢–µ–∫—É—â–∏–π | –¶–µ–ª–µ–≤–æ–π | –°—Ç–∞—Ç—É—Å |
|----------|---------|---------|--------|
| PEP 8 —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ | 70% | 95% | ‚ö†Ô∏è |
| –û–û–ü –ø—Ä–∏–Ω—Ü–∏–ø—ã | 60% | 90% | ‚ùå |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | 40% | 85% | ‚ùå |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | 30% | 95% | ‚ùå |
| –¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å | 20% | 80% | ‚ùå |
| –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | 80% | 90% | ‚úÖ |

---

## üéØ 8. –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ**: –£–±—Ä–∞—Ç—å API –∫–ª—é—á–∏ –∏–∑ –∫–æ–¥–∞
2. **–°–µ–≥–æ–¥–Ω—è**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
3. **–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
4. **–í —Ç–µ—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞**: –ü–æ–ª–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª:** AI Assistant  
**–î–∞—Ç–∞:** 04.09.2025  
**–í–µ—Ä—Å–∏—è:** 1.0
