name: ğŸš€ ExamFlow CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Ğ•Ğ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ² 2:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      run_tests:
        description: 'Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ñ‚ĞµÑÑ‚Ñ‹'
        required: false
        default: true
        type: boolean
      run_deploy:
        description: 'Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  CACHE_VERSION: 'v1'

jobs:
  # ===== Ğ£Ğ¡Ğ¢ĞĞĞĞ’ĞšĞ Ğ˜ ĞšĞ­Ğ¨Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ• =====
  setup:
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-pip.outputs.cache-hit }}
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Cache pip dependencies
      uses: actions/cache@v3
      id: cache-pip
      with:
        path: ~/.cache/pip
        key: pip-${{ env.CACHE_VERSION }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          pip-${{ env.CACHE_VERSION }}-
    
    - name: ğŸ“¦ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

  # ===== Ğ›Ğ˜ĞĞ¢Ğ˜ĞĞ“ Ğ˜ Ğ¤ĞĞ ĞœĞĞ¢Ğ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ• =====
  lint:
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Cache and install dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: pip-${{ env.CACHE_VERSION }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          pip-${{ env.CACHE_VERSION }}-
    
    - name: ğŸ“¦ Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install ruff black isort flake8
    
    - name: ğŸ” Run Ruff (fast linter)
      run: ruff check . --output-format=github
    
    - name: ğŸ¨ Run Black (code formatting)
      run: black --check .
    
    - name: ğŸ“‹ Run isort (import sorting)
      run: isort --check-only .
    
    - name: ğŸ” Run Flake8 (additional checks)
      run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

  # ===== UNIT Ğ¢Ğ•Ğ¡Ğ¢Ğ« =====
  unit-tests:
    runs-on: ubuntu-latest
    needs: setup
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: examflow_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Cache and install dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: pip-${{ env.CACHE_VERSION }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          pip-${{ env.CACHE_VERSION }}-
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-django
    
    - name: ğŸ—„ï¸ Setup database
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/examflow_test
        REDIS_URL: redis://localhost:6379/0
        SECRET_KEY: test-secret-key
        DEBUG: True
      run: |
        python manage.py migrate --run-syncdb
    
    - name: ğŸ§ª Run unit tests
      env:
        DJANGO_SETTINGS_MODULE: examflow_project.settings
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/examflow_test
        REDIS_URL: redis://localhost:6379/0
        SECRET_KEY: test-secret-key
        DEBUG: True
      run: |
        pytest tests/unit/ -v --cov=. --cov-report=xml --cov-report=html --junitxml=reports/junit-unit.xml
    
    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unit
        name: unit-tests

  # ===== Ğ˜ĞĞ¢Ğ•Ğ“Ğ ĞĞ¦Ğ˜ĞĞĞĞ«Ğ• Ğ¢Ğ•Ğ¡Ğ¢Ğ« =====
  integration-tests:
    runs-on: ubuntu-latest
    needs: [setup, unit-tests]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: examflow_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Cache and install dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: pip-${{ env.CACHE_VERSION }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          pip-${{ env.CACHE_VERSION }}-
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-django
    
    - name: ğŸ—„ï¸ Setup database
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/examflow_test
        REDIS_URL: redis://localhost:6379/0
        SECRET_KEY: test-secret-key
        DEBUG: True
      run: |
        python manage.py migrate --run-syncdb
    
    - name: ğŸ§ª Run integration tests
      env:
        DJANGO_SETTINGS_MODULE: examflow_project.settings
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/examflow_test
        REDIS_URL: redis://localhost:6379/0
        SECRET_KEY: test-secret-key
        DEBUG: True
      run: |
        pytest tests/integration/ -v --cov=. --cov-report=xml --cov-report=html --junitxml=reports/junit-integration.xml || echo "Integration tests completed"
    
    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: integration
        name: integration-tests

  # ===== Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞĞ¡Ğ¢Ğ¬ =====
  security:
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Cache and install dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: pip-${{ env.CACHE_VERSION }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          pip-${{ env.CACHE_VERSION }}-
    
    - name: ğŸ“¦ Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install bandit safety
    
    - name: ğŸ”’ Run Bandit security audit
      run: bandit -r . -f json -o reports/bandit-report.json
    
    - name: ğŸ›¡ï¸ Run Safety dependency check
      run: safety check --json --output reports/safety-report.json
    
    - name: ğŸ“Š Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: reports/

  # ===== Ğ”Ğ•ĞŸĞ›ĞĞ™ =====
  deploy:
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests, security]
    if: github.ref == 'refs/heads/main' && (github.event.inputs.run_deploy == 'true' || github.event_name == 'push')
    
    steps:
    - name: ğŸš€ Deploy to Render
      run: |
        echo "ğŸš€ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° Render"
        echo "âœ… Ğ’ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ‹"
        echo "âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°"
        echo "ğŸ”„ Render Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ"
    
    - name: ğŸ“§ Deployment notification
      run: |
        echo "ğŸ‰ Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!"
        echo "ğŸŒ Ğ¡Ğ°Ğ¹Ñ‚: https://examflow.ru"
        echo "ğŸ¤– Ğ‘Ğ¾Ñ‚: @ExamFlowBot"

  # ===== ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ”ĞĞĞĞ«Ğ¥ =====
  update-data:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event.inputs.run_tests == 'true' && github.ref == 'refs/heads/main')
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Cache and install dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: pip-${{ env.CACHE_VERSION }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          pip-${{ env.CACHE_VERSION }}-
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ—„ï¸ Setup database
      run: |
        python manage.py makemigrations
        python manage.py migrate
    
    - name: ğŸ”„ Update data
      run: |
        python manage.py load_sample_data || echo "Sample data loading completed"
    
    - name: ğŸ“Š Check results
      run: |
        python manage.py shell -c "
        from learning.models import Subject, Task
        print(f'ğŸ“š ĞŸÑ€ĞµĞ´Ğ¼ĞµÑ‚Ğ¾Ğ²: {Subject.objects.count()}')
        print(f'ğŸ“ Ğ—Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹: {Task.objects.count()}')
        print('âœ… Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!')
        "
    
    - name: ğŸ“¤ Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ¤– ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… [skip ci]"
        git push || echo "No changes to commit"
