name: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 UTC (6:00 –ø–æ –ú–æ—Å–∫–≤–µ)
    - cron: '0 3 * * *'
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
  push:
    branches: [ main ]
    paths:
      - 'core/fipi_parser_*.py'
      - 'core/management/commands/parse_*.py'

jobs:
  update-database:
    runs-on: ubuntu-latest
    
    steps:
    - name: üöÄ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      
    - name: üêç –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
      run: |
        echo "DEBUG=False" >> .env
        echo "SECRET_KEY=django-insecure-temp-key-for-ci" >> .env
        echo "DATABASE_URL=sqlite:///db.sqlite3" >> .env
        echo "USE_SQLITE=True" >> .env
        
    - name: üóÑÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
      run: |
        python manage.py makemigrations
        python manage.py migrate
        
    - name: üîç –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
      run: |
        python manage.py parse_enhanced --max-tasks=20
      continue-on-error: true
      
    - name: üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      run: |
        python manage.py shell -c "
        from learning.models import Subject, Task
        print(f'üìö –í—Å–µ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤: {Subject.objects.count()}')
        print(f'üìù –í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π: {Task.objects.count()}')
        print('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!')
        "
        
    - name: üì§ –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git diff --quiet && git diff --staged --quiet || git commit -m "ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö [skip ci]"
        git push
      continue-on-error: true
      
    - name: üìß –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
      if: always()
      run: |
        echo "üîÑ –ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
        echo "üìÖ –í—Ä–µ–º—è: $(date)"
        echo "‚úÖ –°—Ç–∞—Ç—É—Å: ${{ job.status }}"
