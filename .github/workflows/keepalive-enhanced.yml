name: ExamFlow 2.0 Enhanced Keepalive

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    - cron: '*/5 * * * *'
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
  push:
    branches: [ main ]
    paths:
      - 'core/keepalive_service.py'
      - 'core/health_check.py'
      - '.github/workflows/keepalive-enhanced.yml'

jobs:
  keepalive:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests psutil
    
    - name: Wake up ExamFlow website
      run: |
        echo "üåê –ü—Ä–æ–±—É–∂–¥–∞–µ–º ExamFlow 2.0..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∞–π—Ç
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º https://examflow.ru..."
        curl -s -o /dev/null -w "Status: %{http_code}, Time: %{time_total}s\n" https://examflow.ru/
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º health check
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º health check..."
        curl -s -o /dev/null -w "Status: %{http_code}, Time: %{time_total}s\n" https://examflow.ru/health/
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å—Ç–æ–π health check
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º simple health check..."
        curl -s -o /dev/null -w "Status: %{http_code}, Time: %{time_total}s\n" https://examflow.ru/health/simple/
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã..."
        curl -s -o /dev/null -w "Features: %{http_code}\n" https://examflow.ru/features/
        curl -s -o /dev/null -w "Pricing: %{http_code}\n" https://examflow.ru/pricing/
        curl -s -o /dev/null -w "Subjects: %{http_code}\n" https://examflow.ru/learning/subjects/
        
        echo "‚úÖ Keepalive –≤—ã–ø–æ–ª–Ω–µ–Ω"
    
    - name: Wake up Telegram bot
      run: |
        echo "ü§ñ –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram –±–æ—Ç–∞..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º webhook –±–æ—Ç–∞
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º webhook –±–æ—Ç–∞..."
        curl -s -o /dev/null -w "Bot webhook: %{http_code}\n" https://examflow.ru/bot/webhook/
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º API —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º API —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞..."
        curl -s -o /dev/null -w "Bot API: %{http_code}\n" https://examflow.ru/bot/api/status/
        
        echo "‚úÖ –ë–æ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω"
    
    - name: Test database connectivity
      run: |
        echo "üóÑÔ∏è –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º API –∑–∞–¥–∞—á..."
        curl -s -o /dev/null -w "Tasks API: %{http_code}\n" https://examflow.ru/api/tasks/random/
        
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º API –ø—Ä–µ–¥–º–µ—Ç–æ–≤..."
        curl -s -o /dev/null -w "Subjects API: %{http_code}\n" https://examflow.ru/api/subjects/
        
        echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"
    
    - name: Test AI services
      run: |
        echo "ü§ñ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ò–ò —Å–µ—Ä–≤–∏—Å—ã..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º AI —á–∞—Ç
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º AI —á–∞—Ç..."
        curl -s -o /dev/null -w "AI Chat: %{http_code}\n" https://examflow.ru/ai/chat/
        
        echo "‚úÖ –ò–ò —Å–µ—Ä–≤–∏—Å—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"
    
    - name: Performance check
      run: |
        echo "‚ö° –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å..."
        
        # –ò–∑–º–µ—Ä—è–µ–º –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
        echo "–ò–∑–º–µ—Ä—è–µ–º –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã..."
        RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" https://examflow.ru/)
        echo "–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${RESPONSE_TIME}s"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏–µ–º–ª–µ–º–æ–µ (–º–µ–Ω–µ–µ 10 —Å–µ–∫—É–Ω–¥)
        if (( $(echo "$RESPONSE_TIME < 10" | bc -l) )); then
          echo "‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –Ω–æ—Ä–º–µ"
        else
          echo "‚ö†Ô∏è –ú–µ–¥–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: ${RESPONSE_TIME}s"
        fi
    
    - name: Log keepalive status
      run: |
        echo "üïê Keepalive –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ $(date)"
        echo "üåê –°–∞–π—Ç: https://examflow.ru"
        echo "ü§ñ –ë–æ—Ç: @ExamFlowBot"
        echo "üìä Health Check: https://examflow.ru/health/"
        echo "üîß Simple Health: https://examflow.ru/health/simple/"
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Keepalive failed at $(date)"
        echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Render Dashboard"
        echo "URL: https://dashboard.render.com"
