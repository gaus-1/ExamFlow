from django.core.management.base import BaseCommand
from learning.models import Subject, Topic, Task
from django.db import transaction


class Command(BaseCommand):
    help = '–ó–∞–≥—Ä—É–∂–∞–µ—Ç –æ–±—Ä–∞–∑—Ü—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è ExamFlow'

    def handle(self, *args, **options):
        self.stdout.write('üìö –ó–ê–ì–†–£–ó–ö–ê –û–ë–†–ê–ó–¶–û–í –î–ê–ù–ù–´–• EXAMFLOW')
        self.stdout.write('=' * 50)
        
        try:
            with transaction.atomic():
                # –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
                if Subject.objects.count() == 0:  # type: ignore
                    self.stdout.write('üìñ –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã...')
                    
                    subjects_data = [
                        {
                            'name': '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞',
                            'description': '–ê–ª–≥–µ–±—Ä–∞, –≥–µ–æ–º–µ—Ç—Ä–∏—è, —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è'
                        },
                        {
                            'name': '–§–∏–∑–∏–∫–∞',
                            'description': '–ú–µ—Ö–∞–Ω–∏–∫–∞, —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ, –æ–ø—Ç–∏–∫–∞'
                        },
                        {
                            'name': '–•–∏–º–∏—è',
                            'description': '–û—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∞—è –∏ –Ω–µ–æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∞—è —Ö–∏–º–∏—è'
                        },
                        {
                            'name': '–ë–∏–æ–ª–æ–≥–∏—è',
                            'description': '–ê–Ω–∞—Ç–æ–º–∏—è, —ç–∫–æ–ª–æ–≥–∏—è, –≥–µ–Ω–µ—Ç–∏–∫–∞'
                        },
                        {
                            'name': '–ò—Å—Ç–æ—Ä–∏—è',
                            'description': '–†–æ—Å—Å–∏–π—Å–∫–∞—è –∏ –≤—Å–µ–º–∏—Ä–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è'
                        },
                        {
                            'name': '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è',
                            'description': '–§–∏–∑–∏—á–µ—Å–∫–∞—è –∏ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è –≥–µ–æ–≥—Ä–∞—Ñ–∏—è'
                        },
                        {
                            'name': '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞',
                            'description': '–†—É—Å—Å–∫–∞—è –∏ –∑–∞—Ä—É–±–µ–∂–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞'
                        },
                        {
                            'name': '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞',
                            'description': '–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞–ª–≥–æ—Ä–∏—Ç–º—ã'
                        }
                    ]
                    
                    subjects = []
                    for data in subjects_data:
                        subject = Subject(**data)
                        subjects.append(subject)
                    Subject.objects.bulk_create(subjects)
                    self.stdout.write(self.style.SUCCESS(f'‚úÖ –°–æ–∑–¥–∞–Ω–æ {len(subjects)} –ø—Ä–µ–¥–º–µ—Ç–æ–≤'))
                    
                    # –°–æ–∑–¥–∞–µ–º —Ç–µ–º—ã –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏
                    math_subject = Subject.objects.get(name='–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞')
                    topics_data = [
                        {'name': '–ê–ª–≥–µ–±—Ä–∞', 'subject': math_subject},
                        {'name': '–ì–µ–æ–º–µ—Ç—Ä–∏—è', 'subject': math_subject},
                        {'name': '–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è', 'subject': math_subject}
                    ]
                    
                    topics = []
                    for data in topics_data:
                        topic = Topic(**data)
                        topics.append(topic)
                    Topic.objects.bulk_create(topics)
                    self.stdout.write(self.style.SUCCESS(f'‚úÖ –°–æ–∑–¥–∞–Ω–æ {len(topics)} —Ç–µ–º –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏'))
                    
                    # –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–∑—Ü—ã –∑–∞–¥–∞–Ω–∏–π
                    self.stdout.write('üìù –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–∑—Ü—ã –∑–∞–¥–∞–Ω–∏–π...')
                    tasks_data = [
                        {
                            'title': '–†–µ—à–∏—Ç–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ: x¬≤ + 5x + 6 = 0',
                            'content': '–ù–∞–π–¥–∏—Ç–µ –∫–æ—Ä–Ω–∏ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ —É—Ä–∞–≤–Ω–µ–Ω–∏—è x¬≤ + 5x + 6 = 0',
                            'answer': 'x‚ÇÅ = -2, x‚ÇÇ = -3',
                            'difficulty': 2,
                            'subject': math_subject
                        },
                        {
                            'title': '–ù–∞–π–¥–∏—Ç–µ –ø–ª–æ—â–∞–¥—å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ —Å–æ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏ 5 –∏ 8',
                            'content': '–í—ã—á–∏—Å–ª–∏—Ç–µ –ø–ª–æ—â–∞–¥—å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞, –µ—Å–ª–∏ –µ–≥–æ —Å—Ç–æ—Ä–æ–Ω—ã —Ä–∞–≤–Ω—ã 5 –∏ 8 –µ–¥–∏–Ω–∏—Ü',
                            'answer': '40 –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü',
                            'difficulty': 1,
                            'subject': math_subject
                        }
                    ]
                    
                    tasks = []
                    for data in tasks_data:
                        task = Task(**data)
                        tasks.append(task)
                    Task.objects.bulk_create(tasks)  # type: ignore
                    self.stdout.write(self.style.SUCCESS(f'‚úÖ –°–æ–∑–¥–∞–Ω–æ {len(tasks)} –æ–±—Ä–∞–∑—Ü–æ–≤ –∑–∞–¥–∞–Ω–∏–π'))  # type: ignore
                    
                else:
                    self.stdout.write('‚ÑπÔ∏è –î–∞–Ω–Ω—ã–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ')
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                self.stdout.write('üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•:')
                self.stdout.write(f'   –ü—Ä–µ–¥–º–µ—Ç—ã: {Subject.objects.count()}')  # type: ignore
                self.stdout.write(f'   –¢–µ–º—ã: {Topic.objects.count()}')  # type: ignore
                self.stdout.write(f'   –ó–∞–¥–∞–Ω–∏—è: {Task.objects.count()}')  # type: ignore
                
        except Exception as e:
            self.stdout.write(self.style.ERROR(f'‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö: {e}'))  # type: ignore
            return
        
        self.stdout.write('=' * 50)
        self.stdout.write(self.style.SUCCESS('üéâ –û–ë–†–ê–ó–¶–´ –î–ê–ù–ù–´–• –ó–ê–ì–†–£–ñ–ï–ù–´!'))  # type: ignore
        self.stdout.write('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ')
        self.stdout.write('‚úÖ –°–∞–π—Ç –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫')