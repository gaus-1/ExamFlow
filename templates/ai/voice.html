{% extends 'base.html' %}
{% load static %}

{% block title %}Голосовой помощник — ExamFlow{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card-tech mb-4">
                <h3 class="mb-3"><i class="fas fa-microphone me-2"></i> Голосовой помощник</h3>
                <p class="text-secondary">Нажмите “Слушать”, задайте вопрос голосом. Если распознавание недоступно в браузере — используйте ввод текста.</p>
                <div class="d-flex gap-2 mb-3">
                    <button id="btn-listen" class="btn-neon"><i class="fas fa-play me-2"></i>Слушать</button>
                    <button id="btn-stop" class="btn-secondary-duolingo"><i class="fas fa-stop me-2"></i>Стоп</button>
                </div>
                <label class="form-label-duolingo">Распознанный текст</label>
                <textarea id="voice-text" class="form-control-duolingo" rows="3" placeholder="Скажите или напишите вопрос..."></textarea>
                <div class="mt-2">
                    <button id="btn-ask" class="btn-neon"><i class="fas fa-paper-plane me-2"></i>Спросить ИИ</button>
                </div>
            </div>
            <div id="voice-result" class="card-tech d-none">
                <h5 class="mb-3">Ответ</h5>
                <div id="voice-answer" class="text-body"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let recognition;
    try {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.onresult = (e) => {
                const text = e.results[0][0].transcript || '';
                document.getElementById('voice-text').value = text;
            };
            recognition.onerror = () => {};
        }
    } catch (e) {}

    document.getElementById('btn-listen').addEventListener('click', () => { if (recognition) recognition.start(); });
    document.getElementById('btn-stop').addEventListener('click', () => { if (recognition) recognition.stop(); });

    document.getElementById('btn-ask').addEventListener('click', async () => {
        const command = document.getElementById('voice-text').value.trim();
        if (!command) return;
        try {
            const res = await fetch('/ai/api/voice/', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] }, body: JSON.stringify({ command }) });
            const data = await res.json();
            document.getElementById('voice-answer').textContent = data.text || data.error || 'Ошибка';
            document.getElementById('voice-result').classList.remove('d-none');
        } catch (e) {
            document.getElementById('voice-answer').textContent = 'Сеть недоступна';
            document.getElementById('voice-result').classList.remove('d-none');
        }
    });
</script>
{% endblock %}
