{% extends 'base.html' %}
{% load static %}

{% block title %}–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ‚Äî ExamFlow{% endblock %}

{% block content %}
<div class="ai-chat-container">
    <div class="Heading_base__14byZ Heading_dark__VO0za Heading_xLarge__9kBY8 mb-4">
        –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç
    </div>
    
    <div class="Paragraph_base__IUndo Paragraph_large__rowKZ mb-4">
        –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ —Ç–µ–º–µ –ï–ì–≠/–û–ì–≠. –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏. –ü—Ä–µ–º–∏—É–º ‚Äî –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤.
    </div>
    
    <div id="ai-limits" class="Paragraph_base__IUndo mb-3" style="color: #666; font-size: 0.875rem;">
        –ó–∞–≥—Ä—É–∑–∫–∞ –ª–∏–º–∏—Ç–∞...
    </div>
    
    <form id="ai-form" class="mb-4">
        <div class="mb-3">
            <label class="Paragraph_base__IUndo" style="display: block; margin-bottom: 8px; font-weight: 500;">
                –í–∞—à –≤–æ–ø—Ä–æ—Å
            </label>
            <textarea 
                id="ai-prompt" 
                class="ai-chat-input" 
                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û–±—ä—è—Å–Ω–∏ —Ç–µ–æ—Ä–µ–º—É —Å–∏–Ω—É—Å–æ–≤ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏..."
            ></textarea>
        </div>
        
        <div class="d-flex gap-2">
            <button type="submit" id="ask-button" class="Button_base__7AwOF Button_blockStyle__J9_bT Button_dark__Vllu2">
                –°–ü–†–û–°–ò–¢–¨
            </button>
        </div>
    </form>
    
    <div id="ai-result" class="ai-response d-none">
        <div class="Heading_base__14byZ Heading_dark__VO0za Heading_medium__wAIJJ mb-3">
            –û—Ç–≤–µ—Ç
        </div>
        <div id="ai-answer" class="Paragraph_base__IUndo Paragraph_large__rowKZ"></div>
        <div id="ai-meta" class="Paragraph_base__IUndo" style="color: #666; font-size: 0.875rem; margin-top: 16px;"></div>
    </div>
</div>

<script>
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–∏–º–∏—Ç–æ–≤
    async function loadLimits() {
        try {
            const res = await fetch('/ai/api/limits/');
            const data = await res.json();
            const d = data.daily || { used: 0, max: 0, remaining: 0 };
            document.getElementById('ai-limits').textContent = `–õ–∏–º–∏—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: ${d.used}/${d.max}. –û—Å—Ç–∞–ª–æ—Å—å: ${d.remaining}`;
        } catch (e) {
            document.getElementById('ai-limits').textContent = '–õ–∏–º–∏—Ç: –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
        }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–∞
    async function sendQuestion() {
        const prompt = document.getElementById('ai-prompt').value.trim();
        if (!prompt) {
            alert('–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å!');
            return;
        }

        const askButton = document.getElementById('ask-button');
        const originalText = askButton.textContent;
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        askButton.disabled = true;
        askButton.textContent = '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...';
        
        try {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            document.getElementById('ai-result').classList.remove('d-none');
            document.getElementById('ai-answer').textContent = 'ü§î –î—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º...';
            document.getElementById('ai-meta').textContent = '';

            const res = await fetch('/ai/api/chat/', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json', 
                    'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] 
                },
                body: JSON.stringify({ prompt })
            });

            const data = await res.json();
            
            if (data.error) {
                document.getElementById('ai-answer').textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.error}`;
            } else {
                document.getElementById('ai-answer').textContent = data.response || '–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω';
            }
            
            document.getElementById('ai-meta').textContent = `–¢–æ–∫–µ–Ω–æ–≤: ${data.tokens_used || 0}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏–º–∏—Ç—ã
            loadLimits();
            
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞:', e);
            document.getElementById('ai-answer').textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.';
            document.getElementById('ai-meta').textContent = '';
        } finally {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            askButton.disabled = false;
            askButton.textContent = originalText;
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–∏–º–∏—Ç—ã
        loadLimits();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        document.getElementById('ai-form').addEventListener('submit', function(e) {
            e.preventDefault();
            sendQuestion();
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –ø–æ–ª–µ
        document.getElementById('ai-prompt').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendQuestion();
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞)
        document.getElementById('ask-button').addEventListener('click', function(e) {
            e.preventDefault();
            sendQuestion();
        });
    });
</script>
{% endblock %}
