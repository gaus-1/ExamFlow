
{% extends 'base.html' %}
{% load static %}

{% block title %}ExamFlow - –ò–ò –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –ï–ì–≠ –∏ –û–ì–≠{% endblock %}

{% block content %}
<div class="container section-padding">
  <div class="home-grid">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –≤–∏–¥–∂–µ—Ç—ã -->
    <aside class="home-aside left">
      <div class="widget animate-on-scroll">
        <h3>–í–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
        <ul class="text-sm" style="margin:0;padding-left:18px;color:var(--aesop-text-light)">
          <li>–°–µ—Ä–∏—è: 7 –¥–Ω–µ–π</li>
          <li>–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å: –≠–∫—Å–ø–µ—Ä—Ç</li>
          <li>–û—á–∫–∏: 1540</li>
        </ul>
      </div>
      <div class="widget animate-on-scroll">
        <h3>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
        <div class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr));gap:8px">
          <a href="{% url 'learning:subjects_list' %}" class="btn-bot" style="text-align:center">–ü—Ä–µ–¥–º–µ—Ç—ã</a>
          <a href="https://t.me/ExamFlowBot" target="_blank" class="btn-bot" style="text-align:center">–ë–æ—Ç</a>
        </div>
      </div>
    </aside>

    <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞: AI + –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main>
      <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –≤–≤–æ–¥–∞ –ò–ò -->
      <section class="animate-on-scroll" style="margin-bottom:24px">
        <div class="ai-chat-container">
          <h1 class="ai-chat-title">ExamFlow</h1>
          <p class="ai-chat-subtitle">–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ò–ò –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ —ç–∫–∑–∞–º–µ–Ω–∞–º</p>

          <div class="ai-input-container ai-advanced">
            <textarea id="ai-textarea" class="ai-textarea" rows="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û–±—ä—è—Å–Ω–∏ —Ç–µ–º—É '–ö–∏–Ω–µ–º–∞—Ç–∏–∫–∞' –¥–ª—è –û–ì–≠‚Ä¶"></textarea>
            <button class="ai-send-btn ai-send-btn-lg" id="ai-send-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>

          <div class="query-examples pills" id="query-pills" style="margin-top:12px">
            <div class="query-example">–ö–∞–∫ —Ä–µ—à–∞—Ç—å –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è?</div>
            <div class="query-example">–°–¥–µ–ª–∞–π –ø–ª–∞–Ω –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –ø–æ —Ñ–∏–∑–∏–∫–µ</div>
            <div class="query-example">–ü–æ—è—Å–Ω–∏ –ø—Ä–∞–≤–∏–ª–æ –ø–∞–¥–µ–∂–µ–π</div>
            <div class="query-example">–†–∞–∑–±–µ—Ä–∏ —Ñ–æ—Ç–æ—Å–∏–Ω—Ç–µ–∑</div>
          </div>
        </div>
      </section>

      <!-- –û–±–ª–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ –ò–ò -->
      <section id="ai-answer-section" class="widget animate-on-scroll" style="display:none">
        <h3 style="margin-top:0">–û—Ç–≤–µ—Ç –ò–ò</h3>
        <div id="ai-answer" class="break-words" style="white-space:pre-wrap"></div>
        <div id="ai-sources" style="margin-top:16px"></div>
        <div id="ai-followups" style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap"></div>
      </section>

      <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç: –∑–∞–¥–∞–Ω–∏—è –§–ò–ü–ò + –∏–Ω—Ñ–æ—Ä–º–±–ª–æ–∫–∏ -->
      <section class="fipi-tab animate-on-scroll">
        <h2 class="fipi-tab-title">–ó–∞–¥–∞–Ω–∏—è –§–ò–ü–ò</h2>
        <div class="subject-grid cards-grid">
          <div class="subject-card" data-subject="math">
            <div class="subject-icon">üìê</div>
            <div class="subject-name">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</div>
          </div>
          <div class="subject-card" data-subject="russian">
            <div class="subject-icon">üìö</div>
            <div class="subject-name">–†—É—Å—Å–∫–∏–π —è–∑—ã–∫</div>
          </div>
          <div class="subject-card" data-subject="physics">
            <div class="subject-icon">‚ö°</div>
            <div class="subject-name">–§–∏–∑–∏–∫–∞</div>
          </div>
          <div class="subject-card" data-subject="chemistry">
            <div class="subject-icon">üß™</div>
            <div class="subject-name">–•–∏–º–∏—è</div>
          </div>
          <div class="subject-card" data-subject="biology">
            <div class="subject-icon">üß¨</div>
            <div class="subject-name">–ë–∏–æ–ª–æ–≥–∏—è</div>
          </div>
          <div class="subject-card" data-subject="history">
            <div class="subject-icon">üèõÔ∏è</div>
            <div class="subject-name">–ò—Å—Ç–æ—Ä–∏—è</div>
          </div>
        </div>
      </section>

      <!-- –ò–Ω—Ñ–æ-–∞–∫–∫–æ—Ä–¥–µ–æ–Ω—ã -->
      <section class="animate-on-scroll" style="margin-top:24px">
        <div class="accordion">
          <div class="accordion-item">
            <div class="accordion-header">
              <div class="accordion-title">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</div>
              <div class="accordion-icon"><i class="fas fa-chevron-down"></i></div>
            </div>
            <div class="accordion-content"><div class="accordion-body">
              <p>ExamFlow –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ò–ò –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.</p>
            </div></div>
          </div>
          <div class="accordion-item">
            <div class="accordion-header">
              <div class="accordion-title">–ü—Ä–∏–º–µ—Ä—ã –∑–∞–¥–∞–Ω–∏–π</div>
              <div class="accordion-icon"><i class="fas fa-chevron-down"></i></div>
            </div>
            <div class="accordion-content"><div class="accordion-body">
              <p>–ó–∞–¥–∞–Ω–∏—è –§–ò–ü–ò –ø–æ –≤—Å–µ–º –ø—Ä–µ–¥–º–µ—Ç–∞–º —Å —Ä–µ—à–µ–Ω–∏—è–º–∏ –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏.</p>
            </div></div>
          </div>
        </div>
      </section>
    </main>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ —Ç–∞—Ä–∏—Ñ—ã -->
    <aside class="home-aside right">
      <div class="widget gamification-wrapper sidebar animate-on-scroll">
        <div class="gamification-card">
          <h3>–ü—Ä–æ–≥—Ä–µ—Å—Å</h3>
          <div class="progress-label"><span>–û–±—â–∏–π</span><span>75%</span></div>
          <div class="progress-bar"><div class="progress-fill" style="width:75%"></div></div>
        </div>
        <div class="gamification-card">
          <h3>–†–µ—à–µ–Ω–æ</h3>
          <div class="progress-label"><span>150/200</span><span>75%</span></div>
          <div class="progress-bar"><div class="progress-fill" style="width:75%"></div></div>
        </div>
        <div class="gamification-card">
          <h3>–£—Ä–æ–≤–µ–Ω—å</h3>
          <div class="progress-label"><span>–≠–∫—Å–ø–µ—Ä—Ç</span><span>90%</span></div>
          <div class="progress-bar"><div class="progress-fill" style="width:90%"></div></div>
        </div>
      </div>
      <div class="widget animate-on-scroll">
        <h3>–¢–∞—Ä–∏—Ñ—ã</h3>
        <details open>
          <summary>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</summary>
          <ul style="margin:12px 0 0;padding-left:18px;color:var(--aesop-text-light)">
            <li>–ë–∞–∑–æ–≤—ã–π ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ</li>
            <li>–ü—Ä–µ–º–∏—É–º ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</li>
            <li>Pro ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤—Å—ë</li>
          </ul>
        </details>
      </div>
    </aside>
  </div>
</div>

<script>
(function(){
  const ta = document.getElementById('ai-textarea');
  const btn = document.getElementById('ai-send-btn');
  const answerBox = document.getElementById('ai-answer');
  const section = document.getElementById('ai-answer-section');
  const sourcesBox = document.getElementById('ai-sources');
  const followupsBox = document.getElementById('ai-followups');

  const autoResize = ()=>{ ta.style.height='auto'; ta.style.height=Math.min(ta.scrollHeight,220)+'px'; };
  ['input','change'].forEach(e=> ta.addEventListener(e, autoResize));
  autoResize();

  document.getElementById('query-pills').addEventListener('click',(e)=>{
    const pill = e.target.closest('.query-example');
    if(!pill) return;
    ta.value = pill.textContent.trim();
    ta.focus();
    ta.dispatchEvent(new Event('input'));
  });

  async function ask(){
    const prompt = (ta.value||'').trim();
    if(!prompt) return;
    btn.disabled = true; btn.classList.add('loading');
    answerBox.textContent = '–î—É–º–∞—é‚Ä¶';
    sourcesBox.innerHTML = '';
    followupsBox.innerHTML = '';
    section.style.display = '';
    try{
      const res = await fetch('{% url "ai:api_chat" %}',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},body:JSON.stringify({prompt})});
      const data = await res.json();
      if(!res.ok){ answerBox.textContent = data.error||'–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞'; return; }
      answerBox.textContent = data.response||'';
      // Sources
      if(Array.isArray(data.sources) && data.sources.length){
        const frag = document.createDocumentFragment();
        const title = document.createElement('div'); title.style.marginBottom='6px'; title.textContent='–ò—Å—Ç–æ—á–Ω–∏–∫–∏:'; frag.appendChild(title);
        data.sources.forEach(s=>{ const a=document.createElement('a'); a.href=s.url; a.target='_blank'; a.rel='noopener'; a.textContent=`[${s.id}] ${s.title}`; const d=document.createElement('div'); d.appendChild(a); frag.appendChild(d); });
        sourcesBox.innerHTML=''; sourcesBox.appendChild(frag);
      }
      // Follow-ups
      if(Array.isArray(data.followups) && data.followups.length){
        data.followups.forEach(f=>{
          if(f.href){ const a=document.createElement('a'); a.className='btn-bot'; a.href=f.href; a.textContent=f.label; followupsBox.appendChild(a); }
          else if(f.action==='refocus-input'){ const b=document.createElement('button'); b.className='btn-bot'; b.textContent=f.label; b.onclick=()=>ta.focus(); followupsBox.appendChild(b); }
        });
      }
      window.scrollTo({top:section.offsetTop-24,behavior:'smooth'});
    }catch(err){ answerBox.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'; }
    finally{ btn.disabled=false; btn.classList.remove('loading'); }
  }
  btn.addEventListener('click', ask);
  ta.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); ask(); }});

  function getCookie(name){ const m=document.cookie.match('(?:^|; )'+name+'=([^;]*)'); return m?decodeURIComponent(m[1]):''; }
})();
</script>
{% endblock %}
