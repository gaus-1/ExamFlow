{% extends 'base.html' %}
{% load static %}

{% block title %}ExamFlow - –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –ï–ì–≠ –∏ –û–ì–≠{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExamFlow - –ò–ò –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –ï–ì–≠</title>
    <!-- Styles -->
    <link rel="stylesheet" href="{% static 'css/examflow-modern.css' %}">
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <header class="header">
        <div class="container">
            <nav class="nav">
                <div class="nav-brand">
                    <span class="brand-icon">üéØ</span>
                    <span class="brand-text">ExamFlow</span>
                </div>
                
                <div class="nav-menu" id="navMenu">
                    <a href="#features" class="nav-link">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</a>
                    <a href="#subjects" class="nav-link">–ü—Ä–µ–¥–º–µ—Ç—ã</a>
                    <a href="https://t.me/ExamFlowBot" class="nav-link" target="_blank">Telegram</a>
                    <a href="{% url 'telegram_auth:telegram_login' %}" class="nav-cta">–í–æ–π—Ç–∏</a>
                </div>
                
                <button class="nav-toggle" id="navToggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </nav>
        </div>
    </header>

    <!-- –ì–ª–∞–≤–Ω–∞—è —Å–µ–∫—Ü–∏—è -->
    <main class="main">
        <section class="hero">
            <div class="container">
                <div class="hero-content">
                    <h1 class="hero-title">
                        <span class="title-accent">ExamFlow AI</span><br>
                        –£–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ï–ì–≠
                    </h1>
                    
                    <p class="hero-subtitle">
                        –ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ –∏–ª–∏ —Ä—É—Å—Å–∫–æ–º—É —è–∑—ã–∫—É –∏ –ø–æ–ª—É—á–∏—Ç–µ 
                        –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
                    </p>
                    
                    <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π AI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
                    <div class="ai-hub" id="aiInterface">
                        <div class="ai-input-group">
                            <input 
                                type="text" 
                                class="ai-input" 
                                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞–∫ —Ä–µ—à–∏—Ç—å —É—Ä–∞–≤–Ω–µ–Ω–∏–µ x¬≤ + 5x + 6 = 0?"
                                maxlength="500"
                                id="aiInput"
                            >
                            <button class="ai-send-btn" onclick="sendAIQuery()" id="aiSendBtn">
                                <svg class="send-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- –ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã -->
                        <div class="quick-questions">
                            <button class="quick-btn" onclick="askQuestion('–ö–∞–∫ —Ä–µ—à–∞—Ç—å –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è?')">
                                üìê –ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
                            </button>
                            <button class="quick-btn" onclick="askQuestion('–ß—Ç–æ —Ç–∞–∫–æ–µ –ø—Ä–∏—á–∞—Å—Ç–∏–µ?')">
                                üìù –ü—Ä–∏—á–∞—Å—Ç–∏–µ
                            </button>
                            <button class="quick-btn" onclick="askQuestion('–ù–∞–π—Ç–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é x¬≥')">
                                üìê –ü—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ
                            </button>
                            <button class="quick-btn" onclick="askQuestion('–ö–∞–∫ –ø–∏—Å–∞—Ç—å —Å–æ—á–∏–Ω–µ–Ω–∏–µ –ï–ì–≠?')">
                                üìù –°–æ—á–∏–Ω–µ–Ω–∏–µ –ï–ì–≠
                            </button>
                        </div>
                        
                        <!-- –û–±–ª–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤ –ò–ò -->
                        <div id="aiChat" class="ai-chat" style="display: none;">
                            <div class="ai-chat-header">
                                <span class="ai-chat-title">üí¨ –î–∏–∞–ª–æ–≥ —Å –ò–ò</span>
                                <button class="clear-context-btn" onclick="clearAIContext()" title="–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞">
                                    üóëÔ∏è
                                </button>
                            </div>
                            <div class="ai-messages" id="aiMessages">
                                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-number">{{ subjects_count|default:2 }}</div>
                            <div class="stat-label">–ü—Ä–µ–¥–º–µ—Ç–∞</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">{{ tasks_count|default:50 }}</div>
                            <div class="stat-label">–ó–∞–¥–∞–Ω–∏–π</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">24/7</div>
                            <div class="stat-label">–ò–ò –ø–æ–¥–¥–µ—Ä–∂–∫–∞</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ -->
        <section id="features" class="features">
            <div class="container">
                <h2 class="section-title">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ ExamFlow</h2>
                
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">ü§ñ</div>
                        <h3 class="feature-title">–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</h3>
                        <p class="feature-desc">
                            –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ –∏ —Ä—É—Å—Å–∫–æ–º—É —è–∑—ã–∫—É
                        </p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">üì±</div>
                        <h3 class="feature-title">Telegram –±–æ—Ç</h3>
                        <p class="feature-desc">
                            –£—á–∏—Ç–µ—Å—å –≤–µ–∑–¥–µ —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –º–µ–∂–¥—É —Å–∞–π—Ç–æ–º –∏ –±–æ—Ç–æ–º
                        </p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">üß†</div>
                        <h3 class="feature-title">–ü–∞–º—è—Ç—å –¥–∏–∞–ª–æ–≥–æ–≤</h3>
                        <p class="feature-desc">
                            –ò–ò –ø–æ–º–Ω–∏—Ç –≤–∞—à–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç—ã
                        </p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">üéØ</div>
                        <h3 class="feature-title">–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è</h3>
                        <p class="feature-desc">
                            –ë–æ–ª–µ–µ 50 –∑–∞–¥–∞–Ω–∏–π —Å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- –ü—Ä–µ–¥–º–µ—Ç—ã -->
        <section id="subjects" class="subjects">
            <div class="container">
                <h2 class="section-title">–ü—Ä–µ–¥–º–µ—Ç—ã</h2>
                
                <div class="subjects-grid">
                    <div class="subject-card" onclick="window.location.href='{% url 'learning:subjects_list' %}'">
                        <div class="subject-icon">üìê</div>
                        <h3 class="subject-title">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</h3>
                        <p class="subject-desc">–ü—Ä–æ—Ñ–∏–ª—å–Ω–∞—è –∏ –±–∞–∑–æ–≤–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –ï–ì–≠, –û–ì–≠</p>
                        <div class="subject-arrow">‚Üí</div>
                    </div>
                    
                    <div class="subject-card" onclick="window.location.href='{% url 'learning:subjects_list' %}'">
                        <div class="subject-icon">üìù</div>
                        <h3 class="subject-title">–†—É—Å—Å–∫–∏–π —è–∑—ã–∫</h3>
                        <p class="subject-desc">–°–æ—á–∏–Ω–µ–Ω–∏–µ, –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞, –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –ï–ì–≠ –∏ –û–ì–≠</p>
                        <div class="subject-arrow">‚Üí</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- –§—É—Ç–µ—Ä -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="footer-main">
                    <div class="footer-brand">
                        <span class="brand-icon">üéØ</span>
                        <span class="brand-text">ExamFlow</span>
                    </div>
                    <p class="footer-desc">
                        –£–º–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –ï–ì–≠ –∏ –û–ì–≠ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞
                    </p>
                </div>
                
                <!-- –°—Å—ã–ª–∫–∏ -->
                <div class="footer-links">
                    <div class="footer-column">
                        <h4 class="footer-heading">–ü—Ä–æ–¥—É–∫—Ç</h4>
                        <a href="#features" class="footer-link">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</a>
                        <a href="#subjects" class="footer-link">–ü—Ä–µ–¥–º–µ—Ç—ã</a>
                        <a href="{% url 'learning:subjects_list' %}" class="footer-link">–ü—Ä–∞–∫—Ç–∏–∫–∞</a>
                    </div>
                    
                    <div class="footer-column">
                        <h4 class="footer-heading">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h4>
                        <a href="{% url 'faq' %}" class="footer-link">FAQ</a>
                        <a href="https://t.me/ExamFlowBot" class="footer-link" target="_blank">Telegram –±–æ—Ç</a>
                        <a href="#" class="footer-link">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
                    </div>
                    
                    <div class="footer-column">
                        <h4 class="footer-heading">–ö–æ–º–ø–∞–Ω–∏—è</h4>
                        <a href="#" class="footer-link">–û –Ω–∞—Å</a>
                        <a href="#" class="footer-link">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
                        <a href="#" class="footer-link">–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a>
                    </div>
                </div>
                
                <!-- Telegram QR -->
                <div class="footer-qr">
                    <div class="qr-container">
                        <img src="{% static 'images/qr-examflow-bot.png' %}" alt="QR-–∫–æ–¥ @ExamFlowBot" class="qr-image">
                        <div class="qr-info">
                            <h4 class="qr-title">@ExamFlowBot</h4>
                            <p class="qr-desc">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞</p>
                            <a href="https://t.me/ExamFlowBot" class="qr-link" target="_blank">
                                –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –ö–æ–ø–∏—Ä–∞–π—Ç -->
            <div class="footer-bottom">
                <p>&copy; 2025 ExamFlow. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
                <div class="footer-social">
                    <a href="https://t.me/ExamFlowBot" class="social-link" target="_blank">Telegram</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é -->
    <div class="mobile-overlay" id="mobileOverlay">
        <div class="mobile-menu">
            <div class="mobile-header">
                <span class="brand-icon">üéØ</span>
                <span class="brand-text">ExamFlow</span>
                <button class="close-btn" onclick="toggleMobileMenu()">‚úï</button>
            </div>
            
            <nav class="mobile-nav">
                <a href="#features" class="mobile-link" onclick="toggleMobileMenu()">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</a>
                <a href="#subjects" class="mobile-link" onclick="toggleMobileMenu()">–ü—Ä–µ–¥–º–µ—Ç—ã</a>
                <a href="https://t.me/ExamFlowBot" class="mobile-link" target="_blank">Telegram</a>
                <a href="{% url 'telegram_auth:telegram_login' %}" class="mobile-cta">–í–æ–π—Ç–∏</a>
            </nav>
        </div>
    </div>

    <script>
        // ===== AI –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–¨ (–°–û–•–†–ê–ù–ï–ù–ê 100%) =====
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ –∫ –ò–ò
        async function sendAIQuery() {
            const input = document.getElementById('aiInput');
            const chat = document.getElementById('aiChat');
            const messages = document.getElementById('aiMessages');
            
            if (!input || !input.value.trim()) return;
            
            const question = input.value.trim();
            input.value = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Ç
            chat.style.display = 'block';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            addMessage('user', question);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const loadingId = addMessage('assistant', '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à –≤–æ–ø—Ä–æ—Å...', true);
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API (–û–†–ò–ì–ò–ù–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê)
                const response = await fetch('/ai/api/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ prompt: question })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                removeMessage(loadingId);
                
                if (data.answer) {
                    addMessage('assistant', data.answer);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (data.sources && data.sources.length > 0) {
                        const sourcesText = 'üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏:\n' + data.sources.slice(0, 3).map(s => s.title || s.url).join('\n');
                        addMessage('assistant', sourcesText, false, 'sources');
                    }
                } else if (data.error) {
                    addMessage('assistant', `‚ùå ${data.error}`);
                } else {
                    addMessage('assistant', '–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å.');
                }
                
            } catch (error) {
                console.error('AI API Error:', error);
                removeMessage(loadingId);
                
                // –ü—Ä–æ–±—É–µ–º —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π API (–°–û–•–†–ê–ù–ï–ù–ê –õ–û–ì–ò–ö–ê)
                try {
                    console.log('üö® –ü—Ä–æ–±—É–µ–º —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π AI API...');
                    const emergencyResponse = await fetch('/ai/emergency/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ prompt: question })
                    });
                    
                    if (emergencyResponse.ok) {
                        const emergencyData = await emergencyResponse.json();
                        if (emergencyData.answer) {
                            addMessage('assistant', emergencyData.answer);
                        } else {
                            addMessage('assistant', '‚ùå –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å —Ç–∞–∫–∂–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                        }
                    } else {
                        addMessage('assistant', '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                    }
                } catch (emergencyError) {
                    console.error('Emergency AI API Error:', emergencyError);
                    addMessage('assistant', '‚ùå –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –ò–ò –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                }
            }
        }
        
        // –ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã
        function askQuestion(question) {
            const input = document.getElementById('aiInput');
            if (input) {
                input.value = question;
                sendAIQuery();
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç (–û–†–ò–ì–ò–ù–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê)
        function addMessage(type, text, isLoading = false, messageType = 'normal') {
            const messages = document.getElementById('aiMessages');
            const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = `message ${type} ${messageType}`;
            
            if (isLoading) {
                messageDiv.innerHTML = `
                    <div class="message-content loading">
                        <div class="message-avatar">ü§ñ</div>
                        <div class="message-text">
                            <div class="typing-indicator">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                            <span class="loading-text">${text}</span>
                        </div>
                    </div>
                `;
            } else {
                const avatar = type === 'user' ? 'üë§' : 'ü§ñ';
                const formattedText = text.replace(/\n/g, '<br>');
                
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="message-avatar">${avatar}</div>
                        <div class="message-text">${formattedText}</div>
                    </div>
                `;
            }
            
            messages.appendChild(messageDiv);
            
            // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            setTimeout(() => {
                messageDiv.classList.add('show');
            }, 50);
            
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –Ω–æ–≤–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
            
            return messageId;
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function removeMessage(messageId) {
            const message = document.getElementById(messageId);
            if (message) {
                message.classList.add('removing');
                setTimeout(() => {
                    message.remove();
                }, 300);
            }
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ò–ò
        async function clearAIContext() {
            try {
                const response = await fetch('/ai/clear-context/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                    const messages = document.getElementById('aiMessages');
                    if (messages) {
                        messages.innerHTML = '';
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    addMessage('assistant', 'üóëÔ∏è –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–µ–Ω–∞. –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä!');
                } else {
                    addMessage('assistant', '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:', error);
                addMessage('assistant', '‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏');
            }
        }
        
        // –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é
        function toggleMobileMenu() {
            const overlay = document.getElementById('mobileOverlay');
            const toggle = document.getElementById('navToggle');
            
            if (overlay && toggle) {
                overlay.classList.toggle('active');
                toggle.classList.toggle('active');
            }
        }
        
        // –§–æ–∫—É—Å –Ω–∞ AI –∏–Ω–ø—É—Ç–µ
        function focusAI() {
            const aiInput = document.getElementById('aiInput');
            if (aiInput) {
                aiInput.focus();
                aiInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞ (–û–†–ò–ì–ò–ù–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ AI –∏–Ω–ø—É—Ç–µ (–û–†–ò–ì–ò–ù–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê)
            const aiInput = document.getElementById('aiInput');
            if (aiInput) {
                aiInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendAIQuery();
                    }
                });
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
                aiInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });
            }
            
            // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —è–∫–æ—Ä—è–º (–û–†–ò–ì–ò–ù–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê)
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href').substring(1);
                    const targetElement = document.getElementById(targetId);
                    
                    if (targetElement) {
                        targetElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å –∏–∑ sessionStorage
            if (window.location.hash === '#ai-interface' && sessionStorage.getItem('aiQuestion')) {
                setTimeout(() => {
                    const savedQuestion = sessionStorage.getItem('aiQuestion');
                    if (savedQuestion && aiInput) {
                        aiInput.value = savedQuestion;
                        sessionStorage.removeItem('aiQuestion');
                        aiInput.focus();
                        sendAIQuery();
                    }
                }, 500);
            }
            
            // –ê–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('animate-in');
                    }
                });
            }, observerOptions);
            
            // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
            document.querySelectorAll('.feature-card, .subject-card, .stat-item').forEach(el => {
                observer.observe(el);
            });
        });
    </script>
</body>
</html>
{% endblock %}
