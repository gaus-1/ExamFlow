{% extends 'telegram_webapp/base.html' %}

{% block content %}
<div class="ai-chat">
    <p style="text-align: center; margin-bottom: 20px; color: var(--tg-theme-hint-color, #999999);">
        –ó–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ï–ì–≠ –∏ –û–ì–≠! ü§ñ
    </p>
    
    <div class="ai-input-container">
        <textarea 
            id="aiInput" 
            class="ai-input" 
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞–∫ —Ä–µ—à–∏—Ç—å —É—Ä–∞–≤–Ω–µ–Ω–∏–µ x¬≤ + 5x + 6 = 0?"
            rows="3"
            maxlength="1000"
        ></textarea>
        
        <button class="btn btn-primary" onclick="sendQuestion()" id="sendBtn">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å
        </button>
    </div>
    
    <div class="ai-response" id="aiResponse">
        <div class="loading" id="loadingIndicator" style="display: none;">
            ü§ñ –î—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º...
        </div>
        <div id="responseText"></div>
    </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
<div style="margin-top: 32px;">
    <button class="btn btn-secondary" onclick="goHome()">
        ‚Üê –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é
    </button>
</div>

<!-- –ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤ -->
<div style="margin-top: 24px;">
    <h4 style="margin-bottom: 12px; color: var(--tg-theme-text-color, #000000);">
        üí° –ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤:
    </h4>
    <div style="display: flex; flex-direction: column; gap: 8px;">
        <button class="example-question" onclick="setQuestion('–ö–∞–∫ —Ä–µ—à–∏—Ç—å –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ x¬≤ + 5x + 6 = 0?')">
            üìê –ö–∞–∫ —Ä–µ—à–∏—Ç—å –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ?
        </button>
        <button class="example-question" onclick="setQuestion('–ß—Ç–æ —Ç–∞–∫–æ–µ –ø—Ä–∏—á–∞—Å—Ç–∏–µ –≤ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ?')">
            üìù –ß—Ç–æ —Ç–∞–∫–æ–µ –ø—Ä–∏—á–∞—Å—Ç–∏–µ –≤ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ?
        </button>
        <button class="example-question" onclick="setQuestion('–ù–∞–π—Ç–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–∏ f(x) = x¬≥ + 2x')">
            üìê –ù–∞–π—Ç–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–∏
        </button>
        <button class="example-question" onclick="setQuestion('–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–∏—Å–∞—Ç—å –¥–µ–µ–ø—Ä–∏—á–∞—Å—Ç–Ω—ã–µ –æ–±–æ—Ä–æ—Ç—ã?')">
            üìù –î–µ–µ–ø—Ä–∏—á–∞—Å—Ç–Ω—ã–µ –æ–±–æ—Ä–æ—Ç—ã
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
.example-question {
    background: var(--tg-theme-secondary-bg-color, #f8f8f8);
    border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
    color: var(--tg-theme-text-color, #000000);
    padding: 12px;
    border-radius: 8px;
    font-size: 14px;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s ease;
}

.example-question:hover {
    background: var(--tg-theme-button-color, #007AFF);
    color: var(--tg-theme-button-text-color, #ffffff);
}
</style>

<script>
async function sendQuestion() {
    const input = document.getElementById('aiInput');
    const responseDiv = document.getElementById('aiResponse');
    const responseText = document.getElementById('responseText');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const sendBtn = document.getElementById('sendBtn');
    
    const question = input.value.trim();
    
    if (!question) {
        showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å');
        return;
    }
    
    if (question.length > 1000) {
        showAlert('–í–æ–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (–º–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤)');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    responseDiv.style.display = 'block';
    loadingIndicator.style.display = 'block';
    responseText.style.display = 'none';
    sendBtn.disabled = true;
    sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è—é...';
    
    try {
        const response = await fetch('/webapp/api/ask/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                prompt: question
            })
        });
        
        const data = await response.json();
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        loadingIndicator.style.display = 'none';
        responseText.style.display = 'block';
        
        if (data.success) {
            responseText.innerHTML = `
                <div style="margin-bottom: 12px;">
                    <strong>ü§ñ ExamFlow AI:</strong>
                </div>
                <div style="line-height: 1.5;">
                    ${data.answer.replace(/\n/g, '<br>')}
                </div>
                ${data.processing_time ? `<div style="margin-top: 12px; font-size: 12px; color: var(--tg-theme-hint-color, #999999);">‚è±Ô∏è ${data.processing_time.toFixed(1)}—Å</div>` : ''}
            `;
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            input.value = '';
            
            // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞
            hapticFeedback();
            
        } else {
            responseText.innerHTML = `
                <div class="error">
                    ‚ùå ${data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'}
                </div>
            `;
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        loadingIndicator.style.display = 'none';
        responseText.style.display = 'block';
        responseText.innerHTML = `
            <div class="error">
                ‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.
            </div>
        `;
    } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å';
    }
}

function setQuestion(question) {
    document.getElementById('aiInput').value = question;
    hapticFeedback();
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter (—Å Ctrl/Cmd)
document.getElementById('aiInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        sendQuestion();
    }
});
</script>
{% endblock %}
